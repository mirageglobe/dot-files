# ==============================================================================
# TMUX CONFIGURATION (dot.tmux.conf)
# ==============================================================================
# Refactored for better organization, modern features, and platform awareness.
# Support for: macOS (Intel/M1), Linux.
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. CORE SETTINGS (SERVER & SESSION)
# ------------------------------------------------------------------------------

# Use dynamic default shell selection (priority: Homebrew > Linuxbrew > System)
# Intel macOS: /usr/local/bin/bash
# M1/M2 Apple Silicon: /opt/homebrew/bin/bash
# Linuxbrew: /home/linuxbrew/.linuxbrew/bin/bash
set -g default-shell /bin/bash
if-shell 'test -x /home/linuxbrew/.linuxbrew/bin/bash' 'set -g default-shell /home/linuxbrew/.linuxbrew/bin/bash'
if-shell 'test -x /usr/local/bin/bash' 'set -g default-shell /usr/local/bin/bash'
if-shell 'test -x /opt/homebrew/bin/bash' 'set -g default-shell /opt/homebrew/bin/bash'

# Terminal support: 256 colors and TrueColor (RGB) support
# This is critical for modern vim themes and color accuracy
set -g default-terminal "screen-256color"

# Increase history limit (default 2000 is often too low)
set -g history-limit 50000

# Fix focus events for terminal editors (Vim/Neovim)
set -g focus-events on

# Decrease command delay for better responsiveness
set -sg escape-time 0

# Enable mouse support
# NOTE: Hold 'Command (âŒ˜)' on macOS to bypass tmux and click URLs directly
set -g mouse on

# Set parent terminal title
set -g set-titles on
set -g set-titles-string "#S / #W"

# ------------------------------------------------------------------------------
# 2. WINDOW & PANE MANAGEMENT
# ------------------------------------------------------------------------------

# Start numbering at 1 (0 is too far on the keyboard)
set -g base-index 1
setw -g pane-base-index 1

# Automatically renumber windows when one is closed
set -g renumber-windows on

# Monitor activity in other windows
setw -g monitor-activity on
set -g visual-activity off # only status bar notification

# Use vi-style keys for copy mode and command prompt
setw -g mode-keys vi
set -g status-keys vi

# ------------------------------------------------------------------------------
# 3. KEY BINDINGS & ALIASES
# ------------------------------------------------------------------------------

# Reload configuration
bind r source-file ~/.tmux.conf \; display "Reloaded ~/.tmux.conf"

# URL picker (prefix + u) - extracts URLs from pane and opens via fzf
bind u run-shell "tmux capture-pane -J -p | grep -oE '(https?|ftp|file):([//]|\\\\\\\\)+[[:alnum:]?#%&@._/-]+' | sort -u | fzf-tmux -d 35% --reverse --multi | xargs open"

# Split panes using | and - (easier to remember)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Quick window navigation
bind -n S-Left  previous-window
bind -n S-Right next-window
bind C-b last-window # Tap prefix twice to toggle windows

# Vim-style pane selection
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Sync panes (send input to all panes in window) - toggle
bind y set-window-option synchronize-panes \; display "Sync Panes: #{?synchronize-panes,ON,OFF}"

# ------------------------------------------------------------------------------
# 4. COPY MODE (VI-STYLE)
# ------------------------------------------------------------------------------

# macOS specific copy using pbcopy
# Requires 'brew install reattach-to-user-namespace' on older macOS versions
# modern tmux/macOS works with just pbcopy
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi o send-keys -X copy-pipe-and-cancel "xargs open"
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"
bind P paste-buffer

# ------------------------------------------------------------------------------
# 5. THEME & STATUS BAR
# ------------------------------------------------------------------------------

# Status bar style
set -g status-interval 10
set -g status-style bg=black,fg=white

# Status left: Session name
set -g status-left-length 40
set -g status-left "#[fg=green]sh: #[fg=blue]#S #[fg=white]| "

# Status right: Date, time, and prefix indicator
set -g status-right-length 60
set -g status-right "#{?client_prefix,#[fg=red]PREFIX ,}#[fg=cyan]%Y-%m-%d #[fg=green]%H:%M "

# Active window style
set-window-option -g window-status-current-style bg=blue,fg=white,bold
set-window-option -g window-status-current-format " #I:#W#F "

# Inactive window style
set-window-option -g window-status-format " #I:#W#F "

# Message/Command line style
set -g message-style bg=yellow,fg=black,bold

# ------------------------------------------------------------------------------
# HELP & DOCUMENTATION
# ------------------------------------------------------------------------------
# Prefix: Ctrl-b
#
# r             : Reload config
# |             : Vertical split
# -             : Horizontal split
# y             : Toggle pane synchronization
# h/j/k/l       : Navigate panes
# H/J/K/L       : Resize panes
# S-Left/Right  : Navigate windows
# [             : Enter copy mode (v to select, y to yank)
# ------------------------------------------------------------------------------
